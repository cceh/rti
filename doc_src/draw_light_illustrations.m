A = [
 0.000248 0.038446 -0.003090 -0.015760 0.196076 1.000000;
 0.032992 0.005702 0.013716 0.181637 0.075514 1.000000;
 0.016349 0.022345 -0.019114 0.127865 -0.149482 1.000000;
 0.010516 0.028178 0.017214 -0.102547 -0.167864 1.000000;
 0.036604 0.002091 -0.008748 -0.191321 0.045724 1.000000;
 0.072739 0.098774 -0.084763 -0.269702 0.314284 1.000000;
 0.046369 0.125145 0.076176 0.215335 0.353758 1.000000;
 0.162355 0.009158 -0.038560 0.402933 -0.095699 1.000000;
 0.001140 0.170374 -0.013935 0.033761 -0.412764 1.000000;
 0.146067 0.025447 0.060967 -0.382187 -0.159521 1.000000;
 0.232511 0.013517 -0.056060 -0.482194 0.116261 1.000000;
 0.001502 0.244526 -0.019162 -0.038750 0.494496 1.000000;
 0.210120 0.035908 0.086862 0.458388 0.189495 1.000000;
 0.103467 0.142561 -0.121451 0.321663 -0.377572 1.000000;
 0.067301 0.178728 0.109675 -0.259424 -0.422762 1.000000;
 0.270449 0.138661 0.193651 -0.520047 -0.372372 1.000000;
 0.264929 0.144181 -0.195443 -0.514713 0.379712 1.000000;
 0.040677 0.368433 0.122421 0.201686 0.606987 1.000000;
 0.409089 0.000021 -0.002940 0.639601 -0.004596 1.000000;
 0.037270 0.371840 -0.117722 0.193055 -0.609787 1.000000;
 0.007403 0.451247 0.057797 -0.086039 -0.671749 1.000000;
 0.442896 0.015753 0.083529 -0.665504 -0.125512 1.000000;
 0.105498 0.353151 -0.193020 -0.324805 0.594265 1.000000;
 0.215756 0.242893 0.228923 0.464495 0.492842 1.000000;
 0.374665 0.083984 -0.177386 0.612099 -0.289800 1.000000;
 0.227663 0.369320 -0.289966 0.477140 -0.607717 1.000000;
 0.185556 0.411427 0.276302 -0.430762 -0.641426 1.000000;
 0.552465 0.044518 -0.156828 -0.743280 0.210994 1.000000;
 0.000826 0.596157 -0.022190 -0.028739 0.772112 1.000000;
 0.526405 0.070578 0.192750 0.725538 0.265665 1.000000;
 0.582769 0.211481 -0.351062 0.763393 -0.459871 1.000000;
 0.040714 0.753537 0.175156 -0.201777 -0.868065 1.000000;
 0.788471 0.005779 0.067505 -0.887959 -0.076023 1.000000;
 0.120562 0.673690 -0.284993 -0.347220 0.820786 1.000000;
 0.453641 0.340610 0.393084 0.673529 0.583618 1.000000;
 0.729319 0.008286 -0.077736 0.854002 -0.091025 1.000000;
 0.031338 0.706267 -0.148772 0.177026 -0.840397 1.000000;
 0.553965 0.183641 0.318952 -0.744288 -0.428533 1.000000;
 0.406212 0.331393 -0.366900 -0.637348 0.575667 1.000000;
 0.123078 0.614527 0.275018 0.350825 0.783918 1.000000;
 0.848886 0.089522 0.275671 0.921350 0.299203 1.000000;
 0.324474 0.613935 -0.446325 0.569626 -0.783540 1.000000;
 0.324276 0.614134 0.446261 -0.569452 -0.783667 1.000000;
 0.848560 0.089849 -0.276121 -0.921173 0.299749 1.000000;
 0.000000 0.938409 -0.000191 -0.000197 0.968715 1.000000;
 0.345946 0.654054 0.475676 0.588172 0.808736 1.000000;
 0.904492 0.095507 -0.293914 0.951048 -0.309042 1.000000;
 0.000000 1.000000 0.000389 -0.000389 -1.000000 1.000000;
 0.904363 0.095637 0.294093 -0.950980 -0.309253 1.000000;
 0.345382 0.654617 -0.475492 -0.587692 0.809084 1.000000;
];
b = [ 123.000000 112.000000 110.000000 122.000000 129.000000 123.000000 110.000000 89.000000 99.000000 131.000000 132.000000 119.000000 91.000000 79.000000 114.000000 121.000000 125.000000 99.000000 69.000000 71.000000 84.000000 126.000000 121.000000 88.000000 54.000000 42.000000 102.000000 126.000000 102.000000 60.000000 24.000000 67.000000 124.000000 105.000000 61.000000 38.000000 46.000000 117.000000 114.000000 82.000000 35.000000 13.000000 89.000000 124.000000 85.000000 57.000000 11.000000 36.000000 117.000000 97.000000]';

function X = ptm(A,b)
  [U S V] = svd(A,0);   % 0 requests thin SVD
  M       = V * diag (1 ./ diag (S)) * U';
  X       = M * b;
end

function [z, c] = poly(X, U, V)
  U2 = U .* U;
  V2 = V .* V;
  UV = U .* V;
  z = X(1) .* U2 + X(2) .* V2 + X(3) .* UV + X(4) .* U + X(5) .* V + X(6);
  c = z;
  # c += permute ([0.7 0.7 0], [1, 3, 2]);
  c(U2 .+ V2 > 1) = -100;
end

function pr (fn)
  print (fn, "-dpng", "-S640,640");
end

V = A(:,4:5);
V(:,3) = 0;

graphics_toolkit ("fltk");
figure (1); clf ();
hax = gca;
grid (hax, "on");
axis ([-1.2, 1.2, -1.2, 1.2, 0, 2.4]);
set (hax, "XTick", -1:1, "YTick", -1:1, "ZTick", 0:2, ...
     "Box", "off", "PlotBoxAspectRatio", [1 1 1])
xlabel ("u");
ylabel ("v");
zlabel ("w");
hold on;

% plot dome
[x y z] = sphere ();
hdome = surf (x, y, z, "facecolor", "none", "linestyle", ":");
hlights = plot3 (V(:,1), V(:,2), sqrt (1 - V(:,1).**2 - V(:,2).**2), ...
   "color", "red", "linestyle", "none", "marker", "*");
view (hax, 45, 45);
pr ("light-3d.png");
delete (hlights);
delete (hdome);

% plot projected lights
z(:) = 0;
hdome = surf (x, y, z, "facecolor", "none", "linestyle", ":");
hlights = plot3 (V(:,1), V(:,2), V(:,3), ...
   "color", "red", "linestyle", "none", "marker", "*");
pr ("light-2d.png");
delete (hlights);

% plot data points
V(:,3) = b;
bars = bar3xy (hax, V);
axis ([-1.2, 1.2, -1.2, 1.2, 0, 150]);
set (hax, "ZTick", 0:25:150);
zlabel ("intensity");
#title ("50 samples");
pr ("light-samples.png");

% fit curve and plot
X = ptm (A, b);
x=linspace(-1,1,50);
y=linspace(-1,1,50);
[xx, yy] = meshgrid (x,y);
[zz, cc] = poly (X, xx, yy);
mesh (xx, yy, zz, cc);
#title ("50 samples and curve fitted");
pr ("light-samples-fit.png");

% plot curve only
delete (bars);
#title ("curve fitted");
pr ("light-fit.png");
